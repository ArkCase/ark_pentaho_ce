<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
	xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:pro="http://www.liquibase.org/xml/ns/pro"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd
						http://www.liquibase.org/xml/ns/pro http://www.liquibase.org/xml/ns/pro/liquibase-pro-latest.xsd">

	<changeSet id="pentaho-quartz-oracle" author="arkcase.container" runInTransaction="false" dbms="oracle">
		<sql>
			CREATE TABLE QRTZ5_JOB_DETAILS 
			(
				JOB_NAME  VARCHAR2(200) NOT NULL,
				JOB_GROUP VARCHAR2(200) NOT NULL,
				DESCRIPTION VARCHAR2(250) NULL,
				JOB_CLASS_NAME   VARCHAR2(250) NOT NULL, 
				IS_DURABLE VARCHAR2(1) NOT NULL,
				IS_VOLATILE VARCHAR2(1) NOT NULL,
				IS_STATEFUL VARCHAR2(1) NOT NULL,
				REQUESTS_RECOVERY VARCHAR2(1) NOT NULL,
				JOB_DATA BLOB NULL,
				PRIMARY KEY (JOB_NAME,JOB_GROUP)
			);

			CREATE TABLE QRTZ5_JOB_LISTENERS
			(
				JOB_NAME  VARCHAR2(200) NOT NULL, 
				JOB_GROUP VARCHAR2(200) NOT NULL,
				JOB_LISTENER VARCHAR2(200) NOT NULL,
				PRIMARY KEY (JOB_NAME,JOB_GROUP,JOB_LISTENER),
				FOREIGN KEY (JOB_NAME,JOB_GROUP) 
					REFERENCES QRTZ5_JOB_DETAILS(JOB_NAME,JOB_GROUP)
			);

			CREATE TABLE QRTZ5_TRIGGERS
			(
				TRIGGER_NAME VARCHAR2(200) NOT NULL,
				TRIGGER_GROUP VARCHAR2(200) NOT NULL,
				JOB_NAME  VARCHAR2(200) NOT NULL, 
				JOB_GROUP VARCHAR2(200) NOT NULL,
				IS_VOLATILE VARCHAR2(1) NOT NULL,
				DESCRIPTION VARCHAR2(250) NULL,
				NEXT_FIRE_TIME NUMBER(38) NULL,
				PREV_FIRE_TIME NUMBER(38) NULL,
				PRIORITY NUMBER(38) NULL,
				TRIGGER_STATE varchar2(16) NOT NULL,
				TRIGGER_TYPE varchar2(8) NOT NULL,
				START_TIME NUMBER(38) NOT NULL,
				END_TIME NUMBER(38) NULL,
				CALENDAR_NAME VARCHAR2(200) NULL,
				MISFIRE_INSTR NUMBER(38) NULL,
				JOB_DATA BLOB NULL,
				PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),
				FOREIGN KEY (JOB_NAME,JOB_GROUP) 
					REFERENCES QRTZ5_JOB_DETAILS(JOB_NAME,JOB_GROUP)
			);

			CREATE TABLE QRTZ5_SIMPLE_TRIGGERS
			(
				TRIGGER_NAME VARCHAR2(200) NOT NULL,
				TRIGGER_GROUP VARCHAR2(200) NOT NULL,
				REPEAT_COUNT NUMBER(38) NOT NULL,
				REPEAT_INTERVAL NUMBER(38) NOT NULL,
				TIMES_TRIGGERED NUMBER(38) NOT NULL,
				PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),
				FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)
					REFERENCES QRTZ5_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)
			);

			CREATE TABLE QRTZ5_CRON_TRIGGERS
			(
				TRIGGER_NAME VARCHAR2(200) NOT NULL,
				TRIGGER_GROUP VARCHAR2(200) NOT NULL,
				CRON_EXPRESSION VARCHAR2(120) NOT NULL,
				TIME_ZONE_ID varchar2(80),
				PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),
				FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)
					REFERENCES QRTZ5_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)
			);

			CREATE TABLE QRTZ5_BLOB_TRIGGERS
			(
				TRIGGER_NAME VARCHAR2(200) NOT NULL,
				TRIGGER_GROUP VARCHAR2(200) NOT NULL,
				BLOB_DATA BLOB NULL,
				PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),
				FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP) 
					REFERENCES QRTZ5_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)
			);

			CREATE TABLE QRTZ5_TRIGGER_LISTENERS
			(
				TRIGGER_NAME  VARCHAR2(200) NOT NULL, 
				TRIGGER_GROUP VARCHAR2(200) NOT NULL,
				TRIGGER_LISTENER VARCHAR2(200) NOT NULL,
				PRIMARY KEY(TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_LISTENER),
				FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)
					REFERENCES QRTZ5_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)
			);

			CREATE TABLE QRTZ5_CALENDARS
			(
				CALENDAR_NAME  VARCHAR2(200) NOT NULL, 
				CALENDAR BLOB NOT NULL,
				PRIMARY KEY (CALENDAR_NAME)
			);

			CREATE TABLE QRTZ5_PAUSED_TRIGGER_GRPS
			(
				TRIGGER_GROUP  VARCHAR2(200) NOT NULL, 
				PRIMARY KEY (TRIGGER_GROUP)
			);

			CREATE TABLE QRTZ5_FIRED_TRIGGERS
			(
				ENTRY_ID varchar2(95) NOT NULL,
				TRIGGER_NAME VARCHAR2(200) NOT NULL,
				TRIGGER_GROUP VARCHAR2(200) NOT NULL,
				IS_VOLATILE varchar2(1) NOT NULL,
				INSTANCE_NAME VARCHAR2(200) NOT NULL,
				FIRED_TIME NUMBER(38) NOT NULL,
				PRIORITY NUMBER(38) NOT NULL,
				STATE varchar2(16) NOT NULL,
				JOB_NAME VARCHAR2(200) NULL,
				JOB_GROUP VARCHAR2(200) NULL,
				IS_STATEFUL varchar2(1) NULL,
				REQUESTS_RECOVERY varchar2(1) NULL,
				PRIMARY KEY (ENTRY_ID)
			);

			CREATE TABLE QRTZ5_SCHEDULER_STATE
			(
				INSTANCE_NAME VARCHAR2(200) NOT NULL,
				LAST_CHECKIN_TIME NUMBER(38) NOT NULL,
				CHECKIN_INTERVAL NUMBER(38) NOT NULL,
				PRIMARY KEY (INSTANCE_NAME)
			);

			CREATE TABLE QRTZ5_LOCKS
			(
				LOCK_NAME  varchar2(40) NOT NULL,
				PRIMARY KEY (LOCK_NAME)
			);

			INSERT INTO QRTZ5_LOCKS values('TRIGGER_ACCESS');
			INSERT INTO QRTZ5_LOCKS values('JOB_ACCESS');
			INSERT INTO QRTZ5_LOCKS values('CALENDAR_ACCESS');
			INSERT INTO QRTZ5_LOCKS values('STATE_ACCESS');
			INSERT INTO QRTZ5_LOCKS values('MISFIRE_ACCESS');
			create index idx_QRTZ5_j_req_recovery on QRTZ5_job_details(REQUESTS_RECOVERY);
			create index idx_QRTZ5_t_next_fire_time on QRTZ5_triggers(NEXT_FIRE_TIME);
			create index idx_QRTZ5_t_state on QRTZ5_triggers(TRIGGER_STATE);
			create index idx_QRTZ5_t_nft_st on QRTZ5_triggers(NEXT_FIRE_TIME,TRIGGER_STATE);
			create index idx_QRTZ5_t_volatile on QRTZ5_triggers(IS_VOLATILE);
			create index idx_QRTZ5_ft_trig_name on QRTZ5_fired_triggers(TRIGGER_NAME);
			create index idx_QRTZ5_ft_trig_group on QRTZ5_fired_triggers(TRIGGER_GROUP);
			create index idx_QRTZ5_ft_trig_nm_gp on QRTZ5_fired_triggers(TRIGGER_NAME,TRIGGER_GROUP);
			create index idx_QRTZ5_ft_trig_volatile on QRTZ5_fired_triggers(IS_VOLATILE);
			create index idx_QRTZ5_ft_trig_inst_name on QRTZ5_fired_triggers(INSTANCE_NAME);
			create index idx_QRTZ5_ft_job_name on QRTZ5_fired_triggers(JOB_NAME);
			create index idx_QRTZ5_ft_job_group on QRTZ5_fired_triggers(JOB_GROUP);
			create index idx_QRTZ5_ft_job_stateful on QRTZ5_fired_triggers(IS_STATEFUL);
			create index idx_QRTZ5_ft_job_req_recovery on QRTZ5_fired_triggers(REQUESTS_RECOVERY);

			ALTER TABLE QRTZ5_TRIGGERS
				MODIFY (
					NEXT_FIRE_TIME NUMBER(38),
					PREV_FIRE_TIME NUMBER(38),
					PRIORITY NUMBER(38),
					START_TIME NUMBER(38),
					END_TIME NUMBER(38),
					MISFIRE_INSTR NUMBER(38)
				);
			
			ALTER TABLE QRTZ5_SIMPLE_TRIGGERS
				MODIFY(
					REPEAT_COUNT NUMBER(38),
					REPEAT_INTERVAL NUMBER(38),
					TIMES_TRIGGERED NUMBER(38)
				);
			
			ALTER TABLE QRTZ5_FIRED_TRIGGERS
				MODIFY(
					FIRED_TIME NUMBER(38),
					PRIORITY NUMBER(38)
				);
			
			ALTER TABLE QRTZ5_SCHEDULER_STATE
				MODIFY(
					LAST_CHECKIN_TIME NUMBER(38),
					CHECKIN_INTERVAL NUMBER(38)
				);
		</sql>

		<rollback>
			DROP TABLE QRTZ5_JOB_LISTENERS;
			DROP TABLE QRTZ5_SIMPLE_TRIGGERS;
			DROP TABLE QRTZ5_CRON_TRIGGERS;
			DROP TABLE QRTZ5_BLOB_TRIGGERS;
			DROP TABLE QRTZ5_TRIGGER_LISTENERS;
			DROP TABLE QRTZ5_CALENDARS;
			DROP TABLE QRTZ5_PAUSED_TRIGGER_GRPS;
			DROP TABLE QRTZ5_FIRED_TRIGGERS;
			DROP TABLE QRTZ5_SCHEDULER_STATE;
			DROP TABLE QRTZ5_LOCKS;
			DROP TABLE QRTZ5_TRIGGERS;
			DROP TABLE QRTZ5_JOB_DETAILS;
		</rollback>
	</changeSet>
</databaseChangeLog>
